<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Brazilian Auto Group</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Adicionar FilePond CSS -->
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet">
    <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Add Car Form -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Add New Car</h2>
                <form id="addCarForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Brand</label>
                            <input type="text" name="brand" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Model</label>
                            <input type="text" name="model" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Year</label>
                            <input type="number" name="year" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mileage (mi)</label>
                            <input type="number" name="mileage" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Miles">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fuel Type</label>
                            <select name="fuelType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select fuel type</option>
                                <option value="gasoline">Gasoline</option>
                                <option value="ethanol">Ethanol</option>
                                <option value="diesel">Diesel</option>
                                <option value="flex">Flex</option>
                                <option value="hybrid">Hybrid</option>
                                <option value="electric">Electric</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cash Price (USD)</label>
                            <input type="number" name="cashPrice" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Financed Price (USD)</label>
                            <input type="number" name="financedPrice" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">VIN Number</label>
                            <input type="text" name="vinNumber" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Car Photos</label>
                        <input id="images" name="images" type="file" accept="image/*" multiple required>
                        <style>
                            /* Deixar a caixa do FilePond mais compacta e não invadir o inventário */
                            .filepond--root {
                                max-width: 350px;
                                min-width: 180px;
                                margin: 0 auto 16px auto;
                                z-index: 1;
                                position: relative;
                            }
                            .filepond--drop-label {
                                min-height: 40px;
                                padding: 8px 0;
                                font-size: 1rem;
                            }
                            .filepond--panel-root {
                                min-height: 50px;
                            }
                            .filepond--item {
                                min-height: 32px !important;
                                max-height: 32px !important;
                                height: 32px !important;
                                margin-bottom: 2px;
                            }
                            .filepond--file {
                                min-height: 32px !important;
                                max-height: 32px !important;
                                height: 32px !important;
                            }
                            .filepond--file-info {
                                font-size: 0.9rem;
                                padding: 0 4px;
                            }
                            .filepond--file-poster {
                                display: none !important;
                            }
                            .filepond--file-action-button {
                                top: 2px !important;
                                right: 2px !important;
                            }
                        </style>
                    </div>
                    <div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Add Car
                        </button>
                    </div>
                </form>
            </div>

            <!-- Cars List -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Cars in Stock</h2>
                <div id="carsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cars will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Car Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Edit Car</h3>
                <form id="editCarForm" class="mt-4 space-y-4">
                    <input type="hidden" name="id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Brand</label>
                            <input type="text" name="brand" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Model</label>
                            <input type="text" name="model" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Year</label>
                            <input type="number" name="year" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mileage (mi)</label>
                            <input type="number" name="mileage" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Miles">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fuel Type</label>
                            <select name="fuelType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="gasoline">Gasoline</option>
                                <option value="ethanol">Ethanol</option>
                                <option value="diesel">Diesel</option>
                                <option value="flex">Flex</option>
                                <option value="hybrid">Hybrid</option>
                                <option value="electric">Electric</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cash Price (USD)</label>
                            <input type="number" name="cashPrice" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Financed Price (USD)</label>
                            <input type="number" name="financedPrice" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">VIN Number</label>
                            <input type="text" name="vinNumber" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Current Photos</label>
                        <div id="currentImages" class="mt-2 grid grid-cols-5 gap-4"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Add/Edit Photos</label>
                        <input id="editImages" name="editImages" type="file" accept="image/*" multiple>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Adicionar FilePond JS -->
    <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>

    <script>
        // Format price in USD
        function formatPrice(price) {
            const num = Number(price);
            if (isNaN(num)) return 'N/A';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(num);
        }

        // Load cars
        async function loadCars() {
            try {
                const response = await fetch('/api/cars');
                const cars = await response.json();
                const carsList = document.getElementById('carsList');
                carsList.innerHTML = '';

                cars.forEach(car => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow overflow-hidden';
                    
                    // Use first image as main image
                    const mainImage = car.images && car.images.length > 0 ? car.images[0] : '/images/no-image.png';
                    
                    // Se a imagem não começar com http, garantir que seja relativa ao servidor
                    const imageUrl = mainImage.startsWith('http') ? mainImage : mainImage;
                    
                    card.innerHTML = `
                        <img src="${imageUrl}" class="w-full h-48 object-cover" alt="Car photo">
                        <div class="p-4">
                            <h3 class="text-lg font-semibold">${car.brand} ${car.model}</h3>
                            <p class="text-gray-600">Year: ${car.year}</p>
                            <p class="text-gray-900 font-bold">Cash Price: <span class="text-green-600">${formatPrice(car.cashPrice)}</span></p>
                            <p class="text-gray-600 text-sm">Financed Price: <span class="text-gray-500">${formatPrice(car.financedPrice)}</span></p>
                            <p class="text-gray-400 text-xs">VIN: ${car.vinNumber}</p>
                            <p class="text-gray-600">Mileage: ${car.mileage} mi</p>
                            <p class="text-gray-600">Fuel: ${car.fuelType}</p>
                            <p class="text-gray-600">Status: ${car.status === 'available' ? 'Available' : 'Sold'}</p>
                            <div class="mt-4 flex space-x-2">
                                <button onclick="openEditModal('${car._id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="deleteCar('${car._id}')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    `;
                    carsList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading cars:', error);
                alert('Error loading cars. Please try again.');
            }
        }

        // Add car
        document.getElementById('addCarForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            // Remove imagens do formData e adiciona as do FilePond
            formData.delete('images');
            if (pond) {
                pond.getFiles().forEach(fileItem => {
                    formData.append('images', fileItem.file);
                });
            }

            try {
                const response = await fetch('/api/cars', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    e.target.reset();
                    if (pond) pond.removeFiles();
                    loadCars();
                    alert('Car added successfully!');
                } else {
                    throw new Error('Error adding car');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding car. Please try again.');
            }
        });

        // Edit car
        let currentCarId = null;
        let pond = null;
        let editPond = null;

        function openEditModal(carId) {
            currentCarId = carId;
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');

            // Limpar imagens do FilePond de edição
            if (editPond) editPond.removeFiles();

            // Load car data
            fetch(`/api/cars/${carId}`)
                .then(response => response.json())
                .then(car => {
                    const form = document.getElementById('editCarForm');
                    form.id.value = car._id;
                    form.brand.value = car.brand;
                    form.model.value = car.model;
                    form.year.value = car.year;
                    form.description.value = car.description;
                    form.mileage.value = car.mileage;
                    form.fuelType.value = car.fuelType;
                    form.cashPrice.value = car.cashPrice;
                    form.financedPrice.value = car.financedPrice;
                    form.vinNumber.value = car.vinNumber;

                    // Carregar imagens atuais no FilePond de edição
                    if (editPond && car.images && car.images.length > 0) {
                        const files = car.images.map((url, idx) => ({
                            source: url,
                            options: {
                                type: 'local',
                                file: {
                                    name: `image${idx}.jpg`,
                                    size: null,
                                    type: 'image/*'
                                },
                                metadata: { url }
                            }
                        }));
                        editPond.files = files;
                    }
                })
                .catch(error => {
                    console.error('Error loading car:', error);
                    alert('Error loading car data. Please try again.');
                });
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            currentCarId = null;
            document.getElementById('editImagePreview').innerHTML = '';
        }

        // Remove existing image
        async function removeExistingImage(carId, imageUrl) {
            if (!confirm('Are you sure you want to remove this image?')) {
                return;
            }

            try {
                const response = await fetch(`/api/cars/${carId}/images`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imageUrl })
                });

                if (response.ok) {
                    openEditModal(carId); // Reload car data
                } else {
                    throw new Error('Error removing image');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error removing image. Please try again.');
            }
        }

        document.getElementById('editCarForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            // Remove imagens do formData e adiciona as do FilePond de edição
            formData.delete('editImages');
            if (editPond) {
                editPond.getFiles().forEach(fileItem => {
                    // Só envia arquivos novos (não os locais já existentes)
                    if (fileItem.origin === FilePond.FileOrigin.INPUT || fileItem.origin === FilePond.FileOrigin.LIMBO) {
                        formData.append('images', fileItem.file);
                    }
                });
            }

            try {
                const response = await fetch(`/api/cars/${currentCarId}`, {
                    method: 'PUT',
                    body: formData
                });

                if (response.ok) {
                    closeEditModal();
                    loadCars();
                    alert('Car updated successfully!');
                } else {
                    throw new Error('Error updating car');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating car. Please try again.');
            }
        });

        // Remove car
        async function deleteCar(carId) {
            if (!confirm('Are you sure you want to remove this car?')) {
                return;
            }

            try {
                const response = await fetch(`/api/cars/${carId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadCars();
                    alert('Car removed successfully!');
                } else {
                    throw new Error('Error removing car');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error removing car. Please try again.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCars();
            
            // Image preview handlers
            document.getElementById('images').addEventListener('change', function() {
                previewImages(this, 'imagePreview');
            });
            
            document.getElementById('editImages').addEventListener('change', function() {
                previewImages(this, 'editImagePreview');
            });

            // Inicializar FilePond para o input de imagens do cadastro
            FilePond.registerPlugin(
                FilePondPluginImagePreview,
                FilePondPluginFileValidateType,
                FilePondPluginFileValidateSize
            );
            const imagesInput = document.querySelector('input[name="images"]');
            if (imagesInput) {
                pond = FilePond.create(imagesInput, {
                    allowMultiple: true,
                    maxFiles: 5,
                    acceptedFileTypes: ['image/*'],
                    maxFileSize: '5MB',
                    labelIdle: 'Arraste as fotos ou <span class="filepond--label-action">clique para selecionar</span> (máx 5)',
                    allowImagePreview: false,
                    allowFilePoster: false,
                    allowFileTypeValidation: true,
                    allowFileSizeValidation: true,
                    itemInsertLocation: 'after',
                    styleItemPanelAspectRatio: 0.2,
                    styleItemPanelRemoveItemPosition: 'right',
                    styleButtonRemoveItemPosition: 'right',
                    styleLoadIndicatorPosition: 'center',
                    styleProgressIndicatorPosition: 'right',
                    styleButtonProcessItemPosition: 'right',
                    stylePanelLayout: 'compact',
                });
            }
            // Inicializar FilePond para o input de imagens do modal de edição
            const editImagesInput = document.getElementById('editImages');
            if (editImagesInput) {
                editPond = FilePond.create(editImagesInput, {
                    allowMultiple: true,
                    maxFiles: 5,
                    acceptedFileTypes: ['image/*'],
                    maxFileSize: '5MB',
                    labelIdle: 'Arraste as fotos ou <span class="filepond--label-action">clique para selecionar</span> (máx 5)',
                    allowImagePreview: false,
                    allowFilePoster: false,
                    allowFileTypeValidation: true,
                    allowFileSizeValidation: true,
                    itemInsertLocation: 'after',
                    styleItemPanelAspectRatio: 0.2,
                    styleItemPanelRemoveItemPosition: 'right',
                    styleButtonRemoveItemPosition: 'right',
                    styleLoadIndicatorPosition: 'center',
                    styleProgressIndicatorPosition: 'right',
                    styleButtonProcessItemPosition: 'right',
                    stylePanelLayout: 'compact',
                });
            }
        });
    </script>
</body>
</html>